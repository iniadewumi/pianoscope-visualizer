<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>HTML5 Microphone Shader Visualizer</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            background-color:#222;
            overflow: hidden;
        }
        canvas {
            display: block;
            width: 100%;
            height: 80%;
            padding: 0;
            margin: 0;
            position: absolute;
        }
        h1 {
            width: 100%;
            font-family: sans-serif;
            position: absolute;
            text-align: center;
            color: white;
        }
        .main-text {
            font-size: 40px;
            top: 40%;
        }
        .sub-text {
            font-size: 30px;
            font-weight: normal;
            top: 60%;
        }
        .sub-text span {
            font-size: 35px;
        }
        .button-container {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 85%;
        }
        button {
            padding: 13px 28px;
            width: 200px;
            text-align: center;
            font-size: 20px;
            border-radius: 12px;
            text-decoration: none;
            border: none;
            cursor: pointer;
            outline: none;
            color: white;
            transition: background-color 200ms linear;
        }
        button span {
            display: block;
            float: left;
            margin-right: 10px;
        }
        .green-button {
            background-color: #4CAF50;
        }
        .green-button:hover {
            background-color: #3e8e41;
        }
        .red-button {
            background-color: #db6247;
        }
        .red-button:hover {
            background-color: #cc5338;
        }
        
        @media only screen and (max-width: 500px) {
            .main-text {
                font-size: 35px; 
            }
            .sub-text {
                font-size: 28px;
            }
            .sub-text span {
                font-size: 30px;
            }
            button {
                font-size: 18px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
</head>
<body>
    <canvas id="visualizer"></canvas>

    <h1 class="main-text">Please allow the use of your microphone.</h1>
    <h1 class="sub-text"></h1>

    <div class="button-container">
        <button id="button" class="green-button"><span class="fa fa-play"></span>Start Listen</button>
    </div>

    <script id="vertexShader" type="x-shader/x-vertex">
        attribute vec2 position;
        void main() {
            gl_Position = vec4(position, 0.0, 1.0);
        }
    </script>

    <script id="fragmentShader" type="x-shader/x-fragment">
        precision highp float;
        
        uniform vec2 iResolution;
        uniform float iTime;
        uniform sampler2D iChannel0;
        
        const float iter = 64.0;
        const float divAng = 24.0 * 6.2831853/360.0;
        const float circRad = 0.23;
        const float rat = 0.045/circRad;
        
        float nearestMult(float v, float of) {
            float m = mod(v, of);
            v -= m * sign(of/2.0 - m);
            return v - mod(v, of);
        }
        
        vec4 pal(float t) {
            return 0.5 + 0.5 * cos(6.283 * (t + vec4(0.0, 1.0, 2.0, 0.0)/3.0));
        }
        
        void main() {
            vec2 R = iResolution.xy;
            vec2 uv = gl_FragCoord.xy;
            vec2 center = vec2(0.0);
            float M = max(R.x, R.y);
            uv = (uv - 0.5 * R) / M / 0.7;
            
            float l = length(uv);
            float sl = texture2D(iChannel0, vec2(0.0, 0.0)).x;
            float sl2 = texture2D(iChannel0, vec2(0.25, 0.0)).x * 0.5;
            float sm = texture2D(iChannel0, vec2(0.5, 0.0)).x * 0.2;
            float sm2 = texture2D(iChannel0, vec2(0.75, 0.0)).x * 0.2;
            float sh = texture2D(iChannel0, vec2(1.0, 0.0)).x * 0.2;
            float st = (sl + sl2 + sm + sm2 + sh);
            
            float time = iTime;
            float sCircRad = circRad * rat;
            float ds = (2.0 + 1.4 * st) * rat;
            float ang, dist;
            vec2 p;
            
            vec4 o = vec4(0.1, 0.1, 0.1, 1.0);
            
            for(float i = 0.0; i < iter; i += 1.0) {
                p = uv - center;
                ang = atan(p.y, p.x);
                ang = nearestMult(ang, divAng);
                center += sCircRad / rat * vec2(cos(ang), sin(ang));
                dist = distance(center, uv);
                
                if (dist <= sCircRad) {
                    o += 30.0 * dist * pal(fract(dist / sCircRad + st + l));
                }
                
                sCircRad *= ds;
            }
            
            gl_FragColor = o;
        }
    </script>

    <script>
        window.onload = function() {
            "use strict";
            
            // Setup WebGL canvas
            var canvas = document.getElementById('visualizer');
            var gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            
            if (!gl) {
                alert('WebGL not supported in your browser!');
                return;
            }
            
            // Set canvas size to match window
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight * 0.8;
                gl.viewport(0, 0, canvas.width, canvas.height);
            }
            window.addEventListener('resize', resizeCanvas, false);
            resizeCanvas();
            
            // Create shader program
            function createShader(gl, type, source) {
                var shader = gl.createShader(type);
                gl.shaderSource(shader, source);
                gl.compileShader(shader);
                
                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                    console.error('Shader compile error:', gl.getShaderInfoLog(shader));
                    gl.deleteShader(shader);
                    return null;
                }
                
                return shader;
            }
            
            var vertexShaderSource = document.getElementById('vertexShader').textContent;
            var fragmentShaderSource = document.getElementById('fragmentShader').textContent;
            
            var vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
            var fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);
            
            var program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);
            
            if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                console.error('Program link error:', gl.getProgramInfoLog(program));
                return;
            }
            
            gl.useProgram(program);
            
            // Create a quad covering the whole canvas
            var positions = new Float32Array([
                -1.0, -1.0,
                 1.0, -1.0,
                -1.0,  1.0,
                 1.0,  1.0
            ]);
            
            var positionBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);
            
            var positionLocation = gl.getAttribLocation(program, 'position');
            gl.enableVertexAttribArray(positionLocation);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            
            // Get uniform locations
            var resolutionLocation = gl.getUniformLocation(program, 'iResolution');
            var timeLocation = gl.getUniformLocation(program, 'iTime');
            var channel0Location = gl.getUniformLocation(program, 'iChannel0');
            
            // Create audio texture
            var textureWidth = 256; // This will store frequency data
            var audioTexture = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, audioTexture);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            
            // Create a 1D array to store audio data
            var audioData = new Uint8Array(textureWidth);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.LUMINANCE, textureWidth, 1, 0, gl.LUMINANCE, gl.UNSIGNED_BYTE, audioData);
            
            // Audio analysis variables
            var h = document.getElementsByTagName('h1')[0];
            var hSub = document.getElementsByTagName('h1')[1];
            var AudioContext;
            var audioContent;
            var analyser;
            var start = false;
            var permission = false;
            var seconds = 0;
            var loud_volume_threshold = 30;
            var frequencyArray;
            var startTime = Date.now();
            
            var soundAllowed = function(stream) {
                permission = true;
                var audioStream = audioContent.createMediaStreamSource(stream);
                analyser = audioContent.createAnalyser();
                var fftSize = 1024;
                
                analyser.fftSize = fftSize;
                audioStream.connect(analyser);
                
                var bufferLength = analyser.frequencyBinCount;
                frequencyArray = new Uint8Array(bufferLength);
                
                var showVolume = function() {
                    setTimeout(showVolume, 500);
                    if (start) {
                        analyser.getByteFrequencyData(frequencyArray);
                        var total = 0
                        for(var i = 0; i < 255; i++) {
                            var x = frequencyArray[i];
                            total += x * x;
                        }
                        var rms = Math.sqrt(total / bufferLength);
                        var db = 20 * (Math.log(rms) / Math.log(10));
                        db = Math.max(db, 0); // sanity check
                        h.innerHTML = Math.floor(db) + " dB";
                
                        if (db >= loud_volume_threshold) {
                            seconds += 0.5;
                            if (seconds >= 5) {
                                hSub.innerHTML = "You've been in loud environment for<span> " + Math.floor(seconds) + " </span>seconds.";
                            }
                        }
                        else {
                            seconds = 0;
                            hSub.innerHTML = "";
                        }
                    }
                    else {
                        h.innerHTML = "";
                        hSub.innerHTML = "";
                    }
                }
                
                showVolume();
                
                // Start render loop
                requestAnimationFrame(render);
            }
            
            var soundNotAllowed = function(error) {
                h.innerHTML = "You must allow your microphone.";
                console.log(error);
            }
            
            // Render loop
            function render() {
                requestAnimationFrame(render);
                
                if (start) {
                    // Update time uniform
                    var time = (Date.now() - startTime) / 1000.0;
                    gl.uniform1f(timeLocation, time);
                    
                    // Update resolution uniform
                    gl.uniform2f(resolutionLocation, canvas.width, canvas.height);
                    
                    // Update audio data texture
                    if (analyser) {
                        analyser.getByteFrequencyData(frequencyArray);
                        
                        // Normalize to 0-1 range for shader
                        for (var i = 0; i < audioData.length; i++) {
                            if (i < frequencyArray.length) {
                                audioData[i] = frequencyArray[i];
                            } else {
                                audioData[i] = 0;
                            }
                        }
                        
                        gl.bindTexture(gl.TEXTURE_2D, audioTexture);
                        gl.texSubImage2D(gl.TEXTURE_2D, 0, 0, 0, textureWidth, 1, gl.LUMINANCE, gl.UNSIGNED_BYTE, audioData);
                    }
                    
                    // Activate texture unit 0 for iChannel0
                    gl.activeTexture(gl.TEXTURE0);
                    gl.bindTexture(gl.TEXTURE_2D, audioTexture);
                    gl.uniform1i(channel0Location, 0);
                    
                    // Draw the quad
                    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
                }
            }
            
            // Button event handler
            document.getElementById('button').onclick = function() {
                if (start) {
                    start = false;
                    this.innerHTML = "<span class='fa fa-play'></span>Start Listen";
                    this.className = "green-button";
                } else {
                    if (!permission) {
                        navigator.mediaDevices.getUserMedia({audio: true})
                            .then(soundAllowed)
                            .catch(soundNotAllowed);
                            
                        AudioContext = window.AudioContext || window.webkitAudioContext;
                        audioContent = new AudioContext();
                    }
                    start = true;
                    this.innerHTML = "<span class='fa fa-stop'></span>Stop Listen";
                    this.className = "red-button";
                }
            };
            
            // Initial render to show something before audio starts
            gl.clearColor(0.1, 0.1, 0.1, 1.0);
            gl.clear(gl.COLOR_BUFFER_BIT);
        };
    </script>
</body>
</html>